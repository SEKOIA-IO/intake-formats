name: deepvisibility
pipeline:
  - name: json_event
    external:
      name: json.parse-json
      properties:
        input_field: "{{original.message}}"

  # Time conversions
  - name: convert_timestamp
    filter: "{{ json_event.message.timestamp and json_event.message.timestamp.millisecondsSinceEpoch | length == 13 }}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.timestamp.millisecondsSinceEpoch[:-3]}}.{{json_event.message.timestamp.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_process_exec_start
    filter: "{{json_event.message.source != null and json_event.message.source.executable.creationTime.millisecondsSinceEpoch != null and json_event.message.source.executable.creationTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.source.executable.creationTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.source.executable.creationTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_source_process_start
    filter: "{{json_event.message.source != null and json_event.message.source.fullPid.startTime.millisecondsSinceEpoch != null and json_event.message.source.fullPid.startTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.source.fullPid.startTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.source.fullPid.startTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_process_start
    filter: "{{json_event.message.process != null and json_event.message.process.fullPid.startTime.millisecondsSinceEpoch != null and json_event.message.process.fullPid.startTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.process.fullPid.startTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.process.fullPid.startTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_parent_process_start
    filter: "{{json_event.message.parent != null and json_event.message.parent.fullPid.startTime.millisecondsSinceEpoch != null and json_event.message.parent.fullPid.startTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.parent.fullPid.startTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.parent.fullPid.startTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_target_process_start
    filter: "{{json_event.message.target != null and json_event.message.target.fullPid.startTime.millisecondsSinceEpoch != null and json_event.message.target.fullPid.startTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.target.fullPid.startTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.target.fullPid.startTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_file_creation_time
    filter: "{{json_event.message.file != null and json_event.message.file.creationTime.millisecondsSinceEpoch != null and json_event.message.file.creationTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.file.creationTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.file.creationTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  - name: convert_target_file_creation_time
    filter: "{{json_event.message.targetFile != null and json_event.message.targetFile.creationTime.millisecondsSinceEpoch != null and json_event.message.targetFile.creationTime.millisecondsSinceEpoch | length == 13}}"
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.targetFile.creationTime.millisecondsSinceEpoch[:-3]}}.{{json_event.message.targetFile.creationTime.millisecondsSinceEpoch[-3:]}}"
        output_field: start_date
        format: timestamp

  # File extractions
  - name: find_target_file_name
    filter: '{{json_event.message.targetFile != null and json_event.message.targetFile.isDir == "E_FALSE"}}'
    external:
      name: grok.match
      properties:
        input_field: json_event.message.targetFile.path
        output_field: file
        pattern: '%{GREEDYDATA}[\\\/]+%{GREEDYDATA:name}$'

  - name: find_dll_name
    filter: "{{json_event.message.path != null}}"
    external:
      name: grok.match
      properties:
        input_field: json_event.message.path
        output_field: file
        pattern: '%{GREEDYDATA}[\\\/]+%{GREEDYDATA:name}$'

  - name: find_reg_value_key_name
    filter: "{{json_event.message.regValue != null and json_event.message.regValue.path != null}}"
    external:
      name: grok.match
      properties:
        input_field: json_event.message.regValue.path
        output_field: key
        pattern: '%{GREEDYDATA}[\\\/]+%{GREEDYDATA:name}$'

  - name: find_reg_key_name
    filter: "{{json_event.message.regKey != null and json_event.message.regKey.path != null}}"
    external:
      name: grok.match
      properties:
        input_field: json_event.message.regKey.path
        output_field: key
        pattern: '%{GREEDYDATA}[\\\/]+%{GREEDYDATA:name}$'

  - name: set_meta_fields

  - name: set_common_fields

  - name: set_source_fields
    filter: "{{json_event.message.source != null}}"

  - name: set_process_fields
    filter: "{{json_event.message.process != null}}"

  - name: set_ip_fields
    filter: "{{json_event.message.sourceAddress != null or json_event.message.destinationAddress != null}}"

  - name: set_source_parent_fields
    filter: "{{json_event.message.source != null and json_event.message.source.parent != null}}"

  - name: set_parent_fields
    filter: "{{json_event.message.parent != null}}"

  - name: set_target_fields
    filter: "{{json_event.message.target != null}}"

  - name: set_dns_fields
    filter: '{{json_event.message.event_type == "dns"}}'

  - name: set_module_load_fields
    filter: '{{json_event.message.event_type == "moduleLoad"}}'

  - name: set_process_signature
    filter: "{{json_event.message.process != null and json_event.message.signature != null}}"

  - name: set_file_signature
    filter: "{{json_event.message.file != null and json_event.message.signature != null}}"

  - name: set_file_fields
    filter: "{{json_event.message.file != null }}"

  - name: set_kernel_fields
    filter: "{{json_event.message.isKernelModule != null }}"

  - name: set_target_file_fields
    filter: "{{json_event.message.targetFile != null}}"

  - name: set_reg_value_fields
    filter: "{{json_event.message.regValue != null}}"

  - name: set_reg_key_fields
    filter: "{{json_event.message.regKey != null}}"

  - name: set_script_fields
    filter: '{{json_event.message.event_type == "scripts"}}'

  - name: set_http_fields
    filter: '{{json_event.message.event_type == "http"}}'

  - name: set_indicator_fields
    filter: '{{json_event.message.event_type == "behavioralIndicators"}}'

stages:
  set_meta_fields:
    actions:
      - set:
          agent.version: "{{json_event.message.meta.agentVersion}}"
          deepvisibility.agent.managment_url: "{{json_event.message.meta.mgmtUrl}}"
          deepvisibility.agent.seq_id: "{{json_event.message.meta.seqId}}"
          deepvisibility.agent.trace_id: "{{json_event.message.meta.traceId}}"
          deepvisibility.agent.uuid: "{{json_event.message.meta.uuid}}"
          deepvisibility.event.type: "{{json_event.message.event_type}}"
          event.action: "{{json_event.message.event_type}}"
          deepvisibility.host.os.revision: "{{json_event.message.meta.osRevision}}"
          deepvisibility.true_context.key: "{{json_event.message.trueContext.key.value}}"
          host.name: "{{json_event.message.meta.computerName}}"
          host.os.family: "{{json_event.message.meta.osFamily}}"
          host.os.name: "{{json_event.message.meta.osName}}"
          host.type: "{{json_event.message.meta.machineType}}"
      - set:
          event.start: "{{convert_timestamp.start_date}}"

  set_common_fields:
    actions:
      - set:
          deepvisibility.process.relations: "{{ json_event.message.relations }}"
          deepvisibility.process.desired_access: "{{ json_event.message.desiredAccess }}"
          deepvisibility.scheduled_task.name: "{{ json_event.message.taskName }}"
          deepvisibility.scheduled_task.trigger_type: "{{ json_event.message.triggerType }}"
          process.exit_code: "{{ json_event.message.exitCode }}"
      - set:
          file.hash.md5: "{{ json_event.message.hashes.md5 }}"
          file.hash.sha1: "{{ json_event.message.hashes.sha1 }}"
          file.hash.sha256: "{{ json_event.message.hashes.sha256 }}"
        filter: "{{json_event.message.hashes != null }}"

  set_source_fields:
    actions:
      - set:
          deepvisibility.process.counters.cross_process_dup_process_handle: "{{json_event.message.source.counters.crossProcessDupProcessHandle}}"
          deepvisibility.process.counters.cross_process_dup_thread_handle: "{{json_event.message.source.counters.crossProcessDupThreadHandle}}"
          deepvisibility.process.counters.cross_process: "{{json_event.message.source.counters.crossProcess}}"
          deepvisibility.process.counters.dns_lookups: "{{json_event.message.source.counters.dnsLookups}}"
          deepvisibility.process.counters.file_creation: "{{json_event.message.source.counters.fileCreation}}"
          deepvisibility.process.counters.file_deletion: "{{json_event.message.source.counters.fileDeletion}}"
          deepvisibility.process.counters.file_modification: "{{json_event.message.source.counters.fileModification}}"
          deepvisibility.process.counters.model_child_process: "{{json_event.message.source.counters.modelChildProcess}}"
          deepvisibility.process.counters.module_load: "{{json_event.message.source.counters.moduleLoad}}"
          deepvisibility.process.counters.net_conn_out: "{{json_event.message.source.counters.netConnOut}}"
          deepvisibility.process.counters.os_child_process: "{{json_event.message.source.counters.osChildProcess}}"
          deepvisibility.process.counters.registry_modification: "{{json_event.message.source.counters.registryModification}}"
          deepvisibility.process.excluded: "{{json_event.message.source.excluded}}"
          deepvisibility.process.executable.is_dir: "{{json_event.message.source.executable.isDir}}"
          deepvisibility.process.executable.name: "{{json_event.message.source.executable.path}}"
          deepvisibility.process.executable.node.key: "{{json_event.message.source.executable.node.key.value}}"
          deepvisibility.process.executable.signature.signed.identity: "{{json_event.message.source.executable.signature.signed.identity}}"
          deepvisibility.process.executable.size_bytes: "{{json_event.message.source.executable.sizeBytes}}"
          deepvisibility.process.executable.start: "{{json_event.message.source.executable.creationTime.millisecondsSinceEpoch}}"
          deepvisibility.process.family: "{{json_event.message.source.subsystem}}"
          deepvisibility.process.integrity_level: "{{json_event.message.source.integrityLevel}}"
          deepvisibility.process.interactive: "{{json_event.message.source.interactive}}"
          deepvisibility.process.is_redirected_command_processor: "{{json_event.message.source.isRedirectedCommandProcessor}}"
          deepvisibility.process.is_wow64: "{{json_event.message.source.isWow64}}"
          deepvisibility.process.node.key: "{{json_event.message.source.node.key.value}}"
          deepvisibility.process.parent.node.key: "{{json_event.message.source.parent.node.key.value}}"
          deepvisibility.process.root: "{{json_event.message.source.root}}"
          deepvisibility.process.session_id: "{{json_event.message.source.sessionId}}"
          deepvisibility.process.true_context.key: "{{json_event.message.source.trueContext.key.value}}"
          deepvisibility.process.user.sid: "{{json_event.message.source.user.sid}}"
          process.command_line: "{{json_event.message.source.commandLine}}"
          process.title: "{{json_event.message.source.name | trim}}"
          process.executable: "{{json_event.message.source.executable.path}}"
          process.pid: "{{json_event.message.source.fullPid.pid}}"
          process.working_directory: '{{json_event.message.source.executable.path.split("\\")[0:-1] | join("\\") }}'
          process.hash.md5: "{{json_event.message.source.executable.hashes.md5}}"
          process.hash.sha1: "{{json_event.message.source.executable.hashes.sha1}}"
          process.hash.sha256: "{{json_event.message.source.executable.hashes.sha256}}"
          user.name: "{{json_event.message.source.user.name}}"
          user.id: "{{json_event.message.source.user.sid}}"
      - set:
          process.start: "{{convert_source_process_start.start_date}}"
        filter: "{{ convert_source_process_start != null }}"
      - set:
          deepvisibility.process.executable.start: "{{convert_process_exec_start.start_date}}"
        filter: "{{ convert_process_exec_start != null }}"
      - set:
          process.name: "{{json_event.message.source.executable.path | basename}}"

  set_process_fields:
    actions:
      - set:
          deepvisibility.process.counters.cross_process_dup_process_handle: "{{json_event.message.process.counters.crossProcessDupProcessHandle}}"
          deepvisibility.process.counters.cross_process_dup_thread_handle: "{{json_event.message.process.counters.crossProcessDupThreadHandle}}"
          deepvisibility.process.counters.cross_process: "{{json_event.message.process.counters.crossProcess}}"
          deepvisibility.process.counters.dns_lookups: "{{json_event.message.process.counters.dnsLookups}}"
          deepvisibility.process.counters.file_creation: "{{json_event.message.process.counters.fileCreation}}"
          deepvisibility.process.counters.file_deletion: "{{json_event.message.process.counters.fileDeletion}}"
          deepvisibility.process.counters.file_modification: "{{json_event.message.process.counters.fileModification}}"
          deepvisibility.process.counters.model_child_process: "{{json_event.message.process.counters.modelChildProcess}}"
          deepvisibility.process.counters.module_load: "{{json_event.message.process.counters.moduleLoad}}"
          deepvisibility.process.counters.net_conn_out: "{{json_event.message.process.counters.netConnOut}}"
          deepvisibility.process.counters.os_child_process: "{{json_event.message.process.counters.osChildProcess}}"
          deepvisibility.process.counters.registry_modification: "{{json_event.message.process.counters.registryModification}}"
          deepvisibility.process.excluded: "{{json_event.message.process.excluded}}"
          deepvisibility.process.executable.is_dir: "{{json_event.message.process.executable.isDir}}"
          deepvisibility.process.executable.name: "{{json_event.message.process.executable.path}}"
          deepvisibility.process.executable.node.key: "{{json_event.message.process.executable.node.key.value}}"
          deepvisibility.process.executable.signature.signed.identity: "{{json_event.message.process.executable.signature.signed.identity}}"
          deepvisibility.process.executable.size_bytes: "{{json_event.message.process.executable.sizeBytes}}"
          deepvisibility.process.executable.start: "{{json_event.message.process.executable.creationTime.millisecondsSinceEpoch}}"
          deepvisibility.process.family: "{{json_event.message.process.subsystem}}"
          deepvisibility.process.integrity_level: "{{json_event.message.process.integrityLevel}}"
          deepvisibility.process.interactive: "{{json_event.message.process.interactive}}"
          deepvisibility.process.is_redirected_command_processor: "{{json_event.message.process.isRedirectedCommandProcessor}}"
          deepvisibility.process.is_wow64: "{{json_event.message.process.isWow64}}"
          deepvisibility.process.node.key: "{{json_event.message.process.node.key.value}}"
          deepvisibility.process.parent.node.key: "{{json_event.message.process.parent.node.key.value}}"
          deepvisibility.process.root: "{{json_event.message.process.root}}"
          deepvisibility.process.session_id: "{{json_event.message.process.sessionId}}"
          deepvisibility.process.true_context.key: "{{json_event.message.process.trueContext.key.value}}"
          deepvisibility.process.user.sid: "{{json_event.message.process.user.sid}}"
          process.command_line: "{{json_event.message.process.commandLine}}"
          process.executable: "{{json_event.message.process.executable.path}}"
          process.title: "{{json_event.message.process.name | trim}}"
          process.pid: "{{json_event.message.process.fullPid.pid}}"
          process.working_directory: '{{json_event.message.process.executable.path.split("\\")[0:-1] | join("\\")}}'
          process.hash.md5: "{{json_event.message.process.executable.hashes.md5}}"
          process.hash.sha1: "{{json_event.message.process.executable.hashes.sha1}}"
          process.hash.sha256: "{{json_event.message.process.executable.hashes.sha256}}"
          user.name: "{{json_event.message.process.user.name}}"
          user.id: "{{json_event.message.process.user.sid}}"
      - set:
          process.start: "{{convert_process_start.start_date}}"
        filter: "{{ convert_process_start != null }}"
      - set:
          process.name: "{{json_event.message.process.executable.path | basename}}"

  set_parent_fields:
    actions:
      - set:
          deepvisibility.process.parent.counters.cross_process_dup_process_handle: "{{json_event.message.parent.counters.crossProcessDupProcessHandle}}"
          deepvisibility.process.parent.counters.cross_process_dup_thread_handle: "{{json_event.message.parent.counters.crossProcessDupThreadHandle}}"
          deepvisibility.process.parent.counters.cross_process: "{{json_event.message.parent.counters.crossProcess}}"
          deepvisibility.process.parent.counters.dns_lookups: "{{json_event.message.parent.counters.dnsLookups}}"
          deepvisibility.process.parent.counters.file_creation: "{{json_event.message.parent.counters.fileCreation}}"
          deepvisibility.process.parent.counters.file_deletion: "{{json_event.message.parent.counters.fileDeletion}}"
          deepvisibility.process.parent.counters.file_modification: "{{json_event.message.parent.counters.fileModification}}"
          deepvisibility.process.parent.counters.model_child_process: "{{json_event.message.parent.counters.modelChildProcess}}"
          deepvisibility.process.parent.counters.module_load: "{{json_event.message.parent.counters.moduleLoad}}"
          deepvisibility.process.parent.counters.net_conn_out: "{{json_event.message.parent.counters.netConnOut}}"
          deepvisibility.process.parent.counters.os_child_process: "{{json_event.message.parent.counters.osChildProcess}}"
          deepvisibility.process.parent.counters.registry_modification: "{{json_event.message.parent.counters.registryModification}}"
          deepvisibility.process.parent.excluded: "{{json_event.message.parent.excluded}}"
          deepvisibility.process.parent.executable.is_dir: "{{json_event.message.parent.executable.isDir}}"
          deepvisibility.process.parent.executable.name: "{{json_event.message.parent.executable.path}}"
          deepvisibility.process.parent.executable.node.key: "{{json_event.message.parent.executable.node.key.value}}"
          deepvisibility.process.parent.executable.signature.signed.identity: "{{json_event.message.parent.executable.signature.signed.identity}}"
          deepvisibility.process.parent.executable.size_bytes: "{{json_event.message.parent.executable.sizeBytes}}"
          deepvisibility.process.parent.executable.start: "{{json_event.message.parent.executable.creationTime.millisecondsSinceEpoch}}"
          deepvisibility.process.parent.family: "{{json_event.message.parent.subsystem}}"
          deepvisibility.process.parent.integrity_level: "{{json_event.message.parent.integrityLevel}}"
          deepvisibility.process.parent.interactive: "{{json_event.message.parent.interactive}}"
          deepvisibility.process.parent.is_redirected_command_processor: "{{json_event.message.parent.isRedirectedCommandProcessor}}"
          deepvisibility.process.parent.is_wow64: "{{json_event.message.parent.isWow64}}"
          deepvisibility.process.parent.node.key: "{{json_event.message.parent.node.key.value}}"
          deepvisibility.process.parent.parent.node.key: "{{json_event.message.parent.parent.node.key.value}}"
          deepvisibility.process.parent.root: "{{json_event.message.parent.root}}"
          deepvisibility.process.parent.session_id: "{{json_event.message.parent.sessionId}}"
          deepvisibility.process.parent.true_context.key: "{{json_event.message.parent.trueContext.key.value}}"
          deepvisibility.process.parent.user.sid: "{{json_event.message.parent.user.sid}}"
          process.parent.command_line: "{{json_event.message.parent.commandLine}}"
          process.parent.title: "{{json_event.message.parent.name | trim}}"
          process.parent.pid: "{{json_event.message.parent.fullPid.pid}}"
          process.parent.executable: "{{json_event.message.parent.executable.path}}"

          process.parent.hash.md5: "{{json_event.message.parent.executable.hashes.md5}}"
          process.parent.hash.sha1: "{{json_event.message.parent.executable.hashes.sha1}}"
          process.parent.hash.sha256: "{{json_event.message.parent.executable.hashes.sha256}}"
      - set:
          process.parent.start: "{{convert_parent_process_start.start_date}}"
        filter: "{{ convert_parent_process_start != null }}"
      - set:
          process.parent.name: "{{json_event.message.parent.executable.path.split('\\\\') | last | lower}}"
          process.parent.working_directory: '{{json_event.message.parent.executable.path.split("\\")[0:-1] | join("\\") }}'
        filter: "{{json_event.message.parent.executable != null and json_event.message.parent.executable.path != null}}"

  set_target_fields:
    actions:
      - set:
          deepvisibility.process.target.counters.cross_process_dup_process_handle: "{{json_event.message.target.counters.crossProcessDupProcessHandle}}"
          deepvisibility.process.target.counters.cross_process_dup_thread_handle: "{{json_event.message.target.counters.crossProcessDupThreadHandle}}"
          deepvisibility.process.target.counters.cross_process: "{{json_event.message.target.counters.crossProcess}}"
          deepvisibility.process.target.counters.dns_lookups: "{{json_event.message.target.counters.dnsLookups}}"
          deepvisibility.process.target.counters.file_creation: "{{json_event.message.target.counters.fileCreation}}"
          deepvisibility.process.target.counters.file_deletion: "{{json_event.message.target.counters.fileDeletion}}"
          deepvisibility.process.target.counters.file_modification: "{{json_event.message.target.counters.fileModification}}"
          deepvisibility.process.target.counters.model_child_process: "{{json_event.message.target.counters.modelChildProcess}}"
          deepvisibility.process.target.counters.module_load: "{{json_event.message.target.counters.moduleLoad}}"
          deepvisibility.process.target.counters.net_conn_out: "{{json_event.message.target.counters.netConnOut}}"
          deepvisibility.process.target.counters.os_child_process: "{{json_event.message.target.counters.osChildProcess}}"
          deepvisibility.process.target.counters.registry_modification: "{{json_event.message.target.counters.registryModification}}"
          deepvisibility.process.target.excluded: "{{json_event.message.target.excluded}}"
          deepvisibility.process.target.executable.is_dir: "{{json_event.message.target.executable.isDir}}"
          deepvisibility.process.target.executable.name: "{{json_event.message.target.executable.path}}"
          deepvisibility.process.target.executable.node.key: "{{json_event.message.target.executable.node.key.value}}"
          deepvisibility.process.target.executable.signature.signed.identity: "{{json_event.message.target.executable.signature.signed.identity}}"
          deepvisibility.process.target.executable.size_bytes: "{{json_event.message.target.executable.sizeBytes}}"
          deepvisibility.process.target.executable.start: "{{json_event.message.target.executable.creationTime.millisecondsSinceEpoch}}"
          deepvisibility.process.target.family: "{{json_event.message.target.subsystem}}"
          deepvisibility.process.target.integrity_level: "{{json_event.message.target.integrityLevel}}"
          deepvisibility.process.target.interactive: "{{json_event.message.target.interactive}}"
          deepvisibility.process.target.is_redirected_command_processor: "{{json_event.message.target.isRedirectedCommandProcessor}}"
          deepvisibility.process.target.is_wow64: "{{json_event.message.target.isWow64}}"
          deepvisibility.process.target.node.key: "{{json_event.message.target.node.key.value}}"
          deepvisibility.process.target.parent.node.key: "{{json_event.message.target.parent.node.key.value}}"
          deepvisibility.process.target.root: "{{json_event.message.target.root}}"
          deepvisibility.process.target.session_id: "{{json_event.message.target.sessionId}}"
          deepvisibility.process.target.true_context.key: "{{json_event.message.target.trueContext.key.value}}"
          deepvisibility.process.target.user.sid: "{{json_event.message.target.user.sid}}"
          deepvisibility.process.target.command_line: "{{json_event.message.target.commandLine}}"
          deepvisibility.process.target.name: "{{json_event.message.target.name}}"
          deepvisibility.process.target.pid: "{{json_event.message.target.fullPid.pid}}"
          deepvisibility.process.target.executable: "{{json_event.message.process.executable.path}}"
          deepvisibility.process.target.working_directory: '{{json_event.message.target.executable.path.split("\\")[0:-1] | join("\\") }}'
          deepvisibility.process.target.hash.md5: "{{json_event.message.target.executable.hashes.md5}}"
          deepvisibility.process.target.hash.sha1: "{{json_event.message.target.executable.hashes.sha1}}"
          deepvisibility.process.target.hash.sha256: "{{json_event.message.target.executable.hashes.sha256}}"
      - set:
          deepvisibility.process.target.start: "{{convert_target_process_start.start_date}}"
        filter: "{{ convert_target_process_start != null }}"

  set_source_parent_fields:
    actions:
      - set:
          deepvisibility.process.parent.counters.cross_process_dup_process_handle: "{{json_event.message.source.parent.counters.crossProcessDupProcessHandle}}"
          deepvisibility.process.parent.counters.cross_process_dup_thread_handle: "{{json_event.message.source.parent.counters.crossProcessDupThreadHandle}}"
          deepvisibility.process.parent.counters.cross_process: "{{json_event.message.source.parent.counters.crossProcess}}"
          deepvisibility.process.parent.counters.dns_lookups: "{{json_event.message.source.parent.counters.dnsLookups}}"
          deepvisibility.process.parent.counters.file_creation: "{{json_event.message.source.parent.counters.fileCreation}}"
          deepvisibility.process.parent.counters.file_deletion: "{{json_event.message.source.parent.counters.fileDeletion}}"
          deepvisibility.process.parent.counters.file_modification: "{{json_event.message.source.parent.counters.fileModification}}"
          deepvisibility.process.parent.counters.model_child_process: "{{json_event.message.source.parent.counters.modelChildProcess}}"
          deepvisibility.process.parent.counters.module_load: "{{json_event.message.source.parent.counters.moduleLoad}}"
          deepvisibility.process.parent.counters.net_conn_out: "{{json_event.message.source.parent.counters.netConnOut}}"
          deepvisibility.process.parent.counters.os_child_process: "{{json_event.message.source.parent.counters.osChildProcess}}"
          deepvisibility.process.parent.counters.registry_modification: "{{json_event.message.source.parent.counters.registryModification}}"
          deepvisibility.process.parent.excluded: "{{json_event.message.source.parent.excluded}}"
          deepvisibility.process.parent.executable.is_dir: "{{json_event.message.source.parent.executable.isDir}}"
          deepvisibility.process.parent.executable.name: "{{json_event.message.source.parent.executable.path}}"
          deepvisibility.process.parent.executable.node.key: "{{json_event.message.source.parent.executable.node.key.value}}"
          deepvisibility.process.parent.executable.signature.signed.identity: "{{json_event.message.source.parent.executable.signature.signed.identity}}"
          deepvisibility.process.parent.executable.size_bytes: "{{json_event.message.source.parent.executable.sizeBytes}}"
          deepvisibility.process.parent.executable.start: "{{json_event.message.source.parent.executable.creationTime.millisecondsSinceEpoch}}"
          deepvisibility.process.parent.family: "{{json_event.message.source.parent.subsystem}}"
          deepvisibility.process.parent.integrity_level: "{{json_event.message.source.parent.integrityLevel}}"
          deepvisibility.process.parent.interactive: "{{json_event.message.source.parent.interactive}}"
          deepvisibility.process.parent.is_redirected_command_processor: "{{json_event.message.source.parent.isRedirectedCommandProcessor}}"
          deepvisibility.process.parent.is_wow64: "{{json_event.message.source.parent.isWow64}}"
          deepvisibility.process.parent.node.key: "{{json_event.message.source.parent.node.key.value}}"
          deepvisibility.process.parent.parent.node.key: "{{json_event.message.source.parent.parent.node.key.value}}"
          deepvisibility.process.parent.root: "{{json_event.message.source.parent.root}}"
          deepvisibility.process.parent.session_id: "{{json_event.message.source.parent.sessionId}}"
          deepvisibility.process.parent.true_context.key: "{{json_event.message.source.parent.trueContext.key.value}}"
          deepvisibility.process.parent.user.sid: "{{json_event.message.source.parent.user.sid}}"
          process.parent.command_line: "{{json_event.message.source.parent.commandLine}}"
          process.parent.title: "{{json_event.message.source.parent.name | trim}}"
          process.parent.pid: "{{json_event.message.source.parent.fullPid.pid}}"
          process.parent.hash.md5: "{{json_event.message.source.parent.executable.hashes.md5}}"
          process.parent.hash.sha1: "{{json_event.message.source.parent.executable.hashes.sha1}}"
          process.parent.hash.sha256: "{{json_event.message.source.parent.executable.hashes.sha256}}"
      - set:
          process.parent.name: "{{json_event.message.source.parent.executable.path.split('\\\\') | last | lower}}"
          process.parent.working_directory: '{{json_event.message.source.parent.executable.path.split("\\")[0:-1] | join("\\") }}'
        filter: "{{json_event.message.source.parent.executable != null and json_event.message.source.parent.executable.path != null}}"

  set_ip_fields:
    actions:
      - set:
          source.address: "{{json_event.message.sourceAddress.address}}"
          source.port: "{{json_event.message.sourceAddress.port}}"
          destination.port: "{{json_event.message.destinationAddress.port}}"

      - set:
          source.ip: "{{json_event.message.sourceAddress.address}}"
        filter: "{{json_event.message.sourceAddress.address| is_ipaddress}}"

      - set:
          destination.ip: "{{json_event.message.destinationAddress.address}}"
        filter: "{{json_event.message.destinationAddress.address| is_ipaddress}}"

      - set:
          network.direction: "inbound"
        filter: '{{ json_event.message.direction == "INCOMING" }}'
      - set:
          network.direction: "outbound"
        filter: '{{ json_event.message.direction == "OUTGOING" }}'

  set_dns_fields:
    actions:
      - set:
          dns.question.name: "{{json_event.message.query}}"
          deepvisibility.dns.answers.results: "{{json_event.message.results}}"

  set_module_load_fields:
    actions:
      - set:
          dll.path: "{{json_event.message.path}}"
          dll.name: "{{find_dll_name.file.name}}"

  set_target_file_fields:
    actions:
      - set:
          deepvisibility.file.location: "{{json_event.message.targetFile.fileLocation}}"
          deepvisibility.file.node.key: "{{json_event.message.targetFile.node.key.value}}"
          file.owner: "{{json_event.message.targetFile.owner.name}}"
          file.path: "{{json_event.message.targetFile.path}}"
          file.size: "{{json_event.message.targetFile.sizeBytes}}"
          file.uid: "{{json_event.message.targetFile.owner.sid}}"
      - set:
          file.type: "dir"
        filter: '{{json_event.message.targetFile.isDir != null and json_event.message.targetFile.isDir != "E_FALSE"}}'
      - set:
          file.type: "file"
        filter: '{{json_event.message.targetFile.isDir == "E_FALSE"}}'
      - set:
          file.name: '{{json_event.message.targetFile.path.split("\\") | last }}'
          file.extension: "{{json_event.message.targetFile.path.split('.')|last}}"
        filter: '{{json_event.message.targetFile != null and json_event.message.targetFile.isDir == "E_FALSE"}}'

      - set:
          file.created: "{{convert_target_file_creation_time.start_date}}"
        filter: "{{convert_target_file_creation_time != null }}"

  set_process_signature:
    actions:
      - set:
          process.code_signature.subject_name: "{{json_event.message.signature.signed.identity}}"
          process.code_signature.exists: "true"
        filter: "{{ json_event.message.signature.signed != null }}"
      - set:
          process.code_signature.valid: "true"
        filter: "{{ json_event.message.signature.signed != null and json_event.message.signature.signed.valid != null }}"
      - set:
          process.code_signature.valid: "false"
        filter: "{{ json_event.message.signature.signed != null and json_event.message.signature.signed.invalid != null }}"

  set_file_signature:
    actions:
      - set:
          file.code_signature.subject_name: "{{json_event.message.signature.signed.identity}}"
          file.code_signature.exists: "true"
        filter: "{{ json_event.message.signature.signed != null }}"
      - set:
          file.code_signature.valid: "true"
        filter: "{{ json_event.message.signature.signed.valid != null }}"
      - set:
          file.code_signature.valid: "false"
        filter: "{{ json_event.message.signature.signed.invalid != null }}"

  set_file_fields:
    actions:
      - set:
          file.path: "{{ json_event.message.file.path }}"
          file.hash.md5: "{{ json_event.message.file.hashes.md5 }}"
          file.hash.sha1: "{{ json_event.message.file.hashes.sha1 }}"
          file.hash.sha256: "{{ json_event.message.file.hashes.sha256 }}"
          file.size: "{{ json_event.message.file.sizeBytes }}"
          file.owner: "{{ json_event.message.file.owner.name }}"
          file.uid: "{{ json_event.message.file.owner.sid }}"
          deepvisibility.file.location: "{{ json_event.message.file.fileLocation }}"
      - set:
          file.type: "dir"
        filter: '{{ json_event.message.file.isDir != "E_FALSE"  }}'
      - set:
          file.name: '{{json_event.message.file.path.split("\\") | last }}'
          file.extension: "{{json_event.message.file.path.split('.')|last}}"
        filter: '{{json_event.message.file != null and json_event.message.file.isDir == "E_FALSE"}}'
      - set:
          file.created: "{{convert_file_creation_time.start_date}}"
        filter: "{{ convert_file_creation_time != null }}"

  set_kernel_fields:
    actions:
      - set:
          deepvisibility.file.is_kernel_module: "true"
        filter: '{{ json_event.message.isKernelModule != "E_FALSE"  }}'
      - set:
          deepvisibility.file.is_kernel_module: "false"
        filter: '{{ json_event.message.isKernelModule == "E_FALSE"  }}'

  set_reg_value_fields:
    actions:
      - set:
          registry.path: "{{ json_event.message.regValue.path }}"
          registry.value: "{{ find_reg_value_key_name.key.name }}"
          # Sadly json doesn't support dict with int as keys so we have to convert them to string
          deepvisibility.registry.value_type: "{{json_event.message.valueType | string() }}"
          deepvisibility.registry.new.value_type: "{{json_event.message.newValueType | string() }}"
          deepvisibility.registry.old.value_type: "{{json_event.message.oldValueType | string() }}"
      - translate:
        dictionary:
          "0": "REG_NONE"
          "1": "REG_SZ"
          "2": "REG_EXPAND_SZ"
          "3": "REG_BINARY"
          "4": "REG_DWORD"
          "5": "REG_DWORD_BIG_ENDIAN"
          "6": "REG_LINK"
          "7": "REG_MULTI_SZ"
          "8": "REG_RESOURCE_LIST"
          "9": "REG_QWORD"
        mapping:
          deepvisibility.registry.old.value_type: deepvisibility.registry.old.data.type
          deepvisibility.registry.new.value_type: registry.data.type
          deepvisibility.registry.value_type: registry.data.type
      - set:
          registry.data.bytes: "{{ json_event.message.newValueData }}"
        filter: "{{ json_event.message.newValueData != null and json_event.message.newValueType in [0, 3]  }}"
      - set:
          registry.data.strings:
            ["{{ json_event.message.newValueData | string() }}"]
        filter: "{{ json_event.message.newValueData != null and json_event.message.newValueType not in [0, 3]  }}"
      - set:
          deepvisibility.registry.old.data.bytes: "{{ json_event.message.oldValueData }}"
        filter: "{{ json_event.message.oldValueData != null and json_event.message.oldValueType in [0, 3]  }}"
      - set:
          deepvisibility.registry.old.data.strings:
            ["{{ json_event.message.oldValueData | string() }}"]
        filter: "{{ json_event.message.oldValueData != null and json_event.message.oldValueType not in [0, 3]  }}"

  set_reg_key_fields:
    actions:
      - set:
          registry.path: "{{ json_event.message.regKey.path }}"
          registry.value: "{{ find_reg_key_name.key.name }}"
          deepvisibility.registry.import_path: "{{ json_event.message.importPath }}"
          deepvisibility.registry.export_path: "{{ json_event.message.exportPath }}"
          deepvisibility.registry.security_information: "{{json_event.message.securityInformation}}"
          deepvisibility.registry.old.key_name: "{{json_event.message.oldKeyName}}"
      - set:
          user.name: "{{json_event.message.owner.user.name}}"
          user.id: "{{json_event.message.owner.user.sid}}"
        filter: "{{ json_event.message.owner != null }}"

  set_script_fields:
    actions:
      - set:
          file.size: "{{ json_event.message.originalSize }}"
          deepvisibility.script.app_name: "{{ json_event.message.appName }}"
      - set:
          file.hash.md5: "{{ json_event.message.hashes.md5 }}"
          file.hash.sha1: "{{ json_event.message.hashes.sha1 }}"
          file.hash.sha256: "{{ json_event.message.hashes.sha256 }}"
        filter: "{{json_event.message.contentHash != null }}"

  set_http_fields:
    actions:
      - set:
          http.request.method: "{{ json_event.message.method }}"
          url.original: "{{ json_event.message.url}}"

  set_indicator_fields:
    actions:
      - set:
          deepvisibility.indicator.id: "{{ json_event.message.indicator }}"
          deepvisibility.indicator.name: "{{ json_event.message.friendlyName }}"
          deepvisibility.indicator.description: "{{ json_event.message.description }}"
          deepvisibility.indicator.long_description: "{{ json_event.message.long_description }}"
          deepvisibility.indicator.category: "{{ json_event.message.category }}"
          deepvisibility.indicator.classification: "{{ json_event.message.classification }}"
          deepvisibility.indicator.metadata: "{{ json_event.message.metadata }}"
          deepvisibility.indicator.tactics: "{{ json_event.message.tactics }}"
# TODO when ingest will be able to manage lists, parse dns.answers.results with grok patern as follows :
# example from intake-formats/SentinelOne/deep_visibility/tests/event_dns.json
#
#  {
#   "dns": {
#     "answers": [
#       {
#         "name": "googlehosted.l.googleusercontent.com",
#         "type": "CNAME",
#         "data": "142.250.179.65"
#       }
#     ]
#   }
# }
