name: sophos-analysis-threat-center
pipeline:
  - external:
      name: json.parse-json
      properties:
        input_field: "{{original.message}}"
        output_field: message
    name: parse_json

  - name: parsed_analysis
    external:
      name: json.parse-json
      properties:
        input_field: "{{parse_json.message.analysis}}"
        output_field: message
    filter: '{{parse_json.message.get("analysis") != None }}'

  - name: parsed_sigma
    external:
      name: json.parse-json
      properties:
        input_field: "{{parse_json.message.ioc_detection_sigma}}"
        output_field: message
    filter: '{{parse_json.message.get("ioc_detection_sigma") != None}}'

  - name: parsed_access
    external:
      name: json.parse-json
      properties:
        input_field: "{{parse_json.message.ioc_detection_access}}"
        output_field: message
    filter: '{{parse_json.message.get("ioc_detection_access") != None }}'

  - name: parsed_impact
    external:
      name: json.parse-json
      properties:
        input_field: "{{parse_json.message.ioc_detection_impact}}"
        output_field: message
    filter: '{{parse_json.message.get("ioc_detection_impact") != None }}'

  - name: parsed_password_date
    external:
      name: date.parse
      properties:
        input_field: "{{parse_json.message.password_last_set}}"
        output_field: date
    filter: '{{parse_json.message.get("password_last_set") != None }}'

  - name: parsed_unix_date
    external:
      name: date.parse
      properties:
        input_field: "{{parse_json.message.ioc_unix_time}}"
        output_field: date
    filter: '{{parse_json.message.get("ioc_unix_time") != None }}'

  - name: parsed_ingestion_date
    external:
      name: date.parse
      properties:
        input_field: "{{parse_json.message.ingestion_timestamp}}"
        output_field: date
    filter: '{{parse_json.message.get("ingestion_timestamp") != None }}'

  - name: set_ecs_fields
  - name: set_sophos_fields

stages:
  set_ecs_fields:
    actions:
      - set:
          "@timestamp": "{{parse_json.message.calendar_time}}"

          event.kind: "event"
          event.severity: "{{parse_json.message.ioc_severity}}"
          event.reason: "{{parse_json.message.description}}"
          event.code: "{{parse_json.message.ioc_detection_id}}"
          event.ingested: "{{parsed_ingestion_date.date}}"

          user.name: "{{parse_json.message.meta_username}}"
          destination.user.name: "{{parse_json.message.target_username}}"

          registry.path: "{{parse_json.message.path}}"
          registry.key: "{{parse_json.message.key}}"
          registry.data.type: "{{parse_json.message.type}}"
          registry.data.strings: "['{{parse_json.message.data}}']"

          source.ip: "{{parse_json.message.meta_public_ip}}"
          source.mac: "{{parse_json.message.meta_mac_address}}"
          source.geo.country_iso_code: "{{parse_json.message.meta_public_ip_country_code}}"
          source.geo.postal_code: "{{parse_json.message.meta_public_ip_postal}}"
          source.geo.city_name: "{{parse_json.message.meta_public_ip_city}}"
          source.geo.country_name: "{{parse_json.message.meta_public_ip_country}}"
          source.bytes: "{{parse_json.message.upload_size}}"

          host.name: "{{parse_json.message.meta_hostname}}"
          host.id: "{{parse_json.message.host_identifier}}"
          host.os.full: "{{parse_json.message.meta_os_name}}"
          host.os.name: "{{parse_json.message.meta_os_platform}}"
          host.os.version: "{{parse_json.message.meta_os_version}}"
          host.domain: "{{parse_json.message.subject_domain}}"

          vulnerability.reference: "{{parse_json.message.ioc_detection_references[2:-2]}}"
          vulnerability.description: "{{parse_json.message.ioc_detection_description}}"

          process.name: "{{parse_json.message.ioc_worker_name}}"
          process.hash.sha1: "{{parse_json.message.sha1}}"
          process.hash.sha256: "{{parse_json.message.sha256 or parse_json.message.lolbins_ml_results.sha256}}"
          process.parent.name: "{{parse_json.message.process_parent_name}}"
          process.command_line: "{{parse_json.message.process_cmd_line or parse_json.message.cmdline}}"

          destination.domain: "{{parse_json.message.target_domain}}"
          destination.port: "{{parse_json.message.remote_port}}"
          destination.address: "{{parse_json.message.remote_address}}"

          threat.indicator.provider: "{{parse_json.message.threat_source}}"
          server.domain: "{{parse_json.message.target_server}}"
          file.path: "{{parse_json.message.ioc_event_path}}"

      - set:
          process.code_signature.exists: false
        filter: '{{parse_json.message.get("is_process_file_signed") != None and parse_json.message.is_process_file_signed == "0"}}'

      - set:
          process.code_signature.exists: true
        filter: '{{parse_json.message.get("is_process_file_signed") != None and parse_json.message.is_process_file_signed == "1"}}'

  set_sophos_fields:
    actions:
      - set:
          sophos.threat_center.record_identifier: "{{parse_json.message.record_identifier}}"
          sophos.threat_center.event.id: "{{parse_json.message.eventid}}"
          sophos.threat_center.id: "{{parse_json.message.endpoint_id}}"
          sophos.threat_center.user_upn: "{{parse_json.message.user_upn}}"
          sophos.threat_center.logon_process: "{{parse_json.message.logon_process}}"
          sophos.threat_center.package: "{{parse_json.message.package}}"
          sophos.threat_center.sha256.reputation_band: "{{parse_json.message.sha256_reputation_band}}"
          sophos.threat_center.endpoint.type: "{{parse_json.message.meta_endpoint_type}}"
          sophos.threat_center.worker.id: "{{parse_json.message.ioc_worker_id}}"
          sophos.threat_center.file.description: "{{parse_json.message.file_description}}"
          sophos.threat_center.aggressive_activity: "{{parse_json.message.meta_aggressive_activity}}"
          sophos.threat_center.detection_id_dedup: "{{parse_json.message.detection_id_dedup}}"
          sophos.threat_center.threat_type: "{{parse_json.message.threat_type}}"

          sophos.threat_center.ioc.log_type: "{{parse_json.message.ioc_log_type}}"
          sophos.threat_center.ioc.attack_type: "{{parse_json.message.ioc_attack_type}}"
          sophos.threat_center.ioc.unix_time: "{{parsed_unix_date.date}}"
          sophos.threat_center.ioc.detection.attack: "{{parse_json.message.ioc_detection_attack}}"
          sophos.threat_center.ioc.detection.cvss: "{{parse_json.message.ioc_detection_cvss}}"
          sophos.threat_center.ioc.detection.weight: "{{parse_json.message.ioc_detection_weight}}"
          sophos.threat_center.ioc.detection.licences: "{{parse_json.message.ioc_detection_licenses}}"
          sophos.threat_center.ioc.detection.type: "{{parse_json.message.ioc_detection_type}}"
          sophos.threat_center.ioc.detection.category: "{{parse_json.message.ioc_detection_category}}"
          sophos.threat_center.ioc.detection.impact.availability: "{{parsed_impact.message.availability}}"
          sophos.threat_center.ioc.detection.impact.integrity: "{{parsed_impact.message.integrity}}"
          sophos.threat_center.ioc.detection.impact.confidentiality: "{{parsed_impact.message.confidentiality}}"
          sophos.threat_center.ioc.detection.access.authentication: "{{parsed_access.message.authentication}}"
          sophos.threat_center.ioc.detection.access.complexity: "{{parsed_access.message.complexity}}"
          sophos.threat_center.ioc.detection.access.vector: "{{parsed_access.message.vector}}"
          sophos.threat_center.ioc.detection.sigma.id: "{{parsed_sigma.message.id}}"

          sophos.threat_center.query.source: "{{parse_json.message.query_source}}"
          sophos.threat_center.query.action: "{{parse_json.message.osquery_action}}"
          sophos.threat_center.query.pack_version: "{{parse_json.message.meta_query_pack_version}}"
          sophos.threat_center.query.name: "{{parse_json.message.query_name}}"

          sophos.threat_center.ml.score: "{{parse_json.message.ml_score or parse_json.message.lolbins_ml_results.score}}"
          sophos.threat_center.ml.score_label: "{{parse_json.message.lolbins_ml_results.score_label}}"
          sophos.threat_center.ml.score_band: "{{parse_json.message.process_ml_score_band or parse_json.message.ml_score_band}}"

          sophos.threat_center.analysis: "{{parsed_analysis.message}}"

          sophos.threat_center.password.last_set: "{{parsed_password_date.date}}"
