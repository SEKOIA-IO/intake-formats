name: PingFederate
ignored_values: []
pipeline:
  - name: parsed_event
    external:
      name: grok.match
      properties:
        input_field: "{{original.message}}"
        output_field: message
        pattern: "(%{PINGF_INTERNAL}|%{PINGF_HTTP})"
        custom_patterns:
          # PingFederate standard logs
          PINGF_INTERNAL: '(?:%{TIMESTAMP_ISO8601:log_timestamp}(?:\s+tid:%{DATA:tracking_id})?\s+(?:%{LOGLEVEL:log_level}\s+\[%{DATA:java_class}\]\s+)?%{GREEDYDATA:kv_pairs})'
          # PingFederate HTTP microservice logs
          PINGF_HTTP: '%{IPORHOST:source_ip}\s+%{USER:ident}\s+%{USER:auth}\s+\[%{HTTPDATE:timestamp}\]\s+"%{WORD:http_request_method}\s+%{DATA:url_original}\s+HTTP/%{NUMBER:http_version}"\s+%{INT:http_response_status_code:int}\s+%{INT:http_response_body_bytes:int}(?:\s+%{INT:extra_field:int})?'

  # Parse application log timestamp
  - name: parsed_date_app
    filter: "{{parsed_event.message.log_timestamp is defined}}"
    external:
      name: date.parse
      properties:
        input_field: "{{parsed_event.message.log_timestamp}}"
        output_field: app_timestamp
        timezone: UTC

  # Parse HTTP access log timestamp
  - name: parsed_date_http
    filter: "{{parsed_event.message.timestamp is defined}}"
    external:
      name: date.parse
      properties:
        input_field: "{{parsed_event.message.timestamp}}"
        output_field: http_timestamp
        format: "%d/%b/%Y:%H:%M:%S %z"
        timezone: UTC

  # Parse key-value pairs from application logs (only for non-HTTP logs)
  - name: kv_parsed
    filter: "{{parsed_event.message.kv_pairs is defined and parsed_event.message.http_request_method is not defined}}"
    external:
      name: kv.parse-kv
      properties:
        input_field: "{{parsed_event.message.kv_pairs}}"
        output_field: message
        value_sep: "="
        item_sep: '\s'

  # Extract hostname from URL in GET: statements
  - name: parsed_get_url
    filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('^GET:'))}}"
    external:
      name: grok.match
      properties:
        input_field: "{{parsed_event.message.kv_pairs}}"
        output_field: url_parts
        pattern: "GET:\\s+(?:https?://)?(?P<hostname>[^:/]+)(?::(?P<port>\\d+))?(?P<path>/\\S*)?"

  # Extract full URL from GET: statements
  - name: parsed_get_full_url
    filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('^GET:'))}}"
    external:
      name: grok.match
      properties:
        input_field: "{{parsed_event.message.kv_pairs}}"
        output_field: url_data
        pattern: "GET:\\s+(?P<full_url>\\S+)"

  # Extract domain from cookie statements
  - name: parsed_cookie_domain
    filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('domain='))}}"
    external:
      name: grok.match
      properties:
        input_field: "{{parsed_event.message.kv_pairs}}"
        output_field: cookie_parts
        pattern: "domain=\\.?(?P<domain>[^;\\}\\s]+)"

  # Extract request ID from tracking messages
  - name: parsed_request_id
    filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('request ID:'))}}"
    external:
      name: grok.match
      properties:
        input_field: "{{parsed_event.message.kv_pairs}}"
        output_field: tracking_parts
        pattern: "request ID:\\s+(?P<request_id>\\S+)"

  # Parse key-value pairs from kv_pairs for events with quoted values (like AUTHN_ATTEMPT)
  - name: kv_reason_parsed
    filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('='))}}"
    external:
      name: kv.parse-kv
      properties:
        input_field: "{{parsed_event.message.kv_pairs}}"
        output_field: reason_data
        value_sep: "="
        item_sep: '\s'

  - name: set_event_common_fields
  - name: set_host_fields
  - name: set_log_fields
  - name: set_http_fields
  - name: set_source_fields
  - name: set_pingfederate_fields
  - name: set_ecs_categorization

stages:
  set_event_common_fields:
    actions:
      - set:
          "@timestamp": "{{parsed_date_app.app_timestamp or parsed_date_http.http_timestamp}}"
          event.kind: event
          event.module: pingfederate
          event.dataset: pingfederate

  set_host_fields:
    actions:
      # For HTTP access logs, use source_ip as host.name
      - set:
          host.name: "{{parsed_event.message.source_ip}}"
        filter: "{{parsed_event.message.source_ip is defined and parsed_event.message.http_request_method is defined}}"

      # For application logs with GET: URL, extract hostname from URL
      - set:
          host.name: "{{parsed_get_url.url_parts.hostname}}"
        filter: "{{parsed_get_url.url_parts.hostname is defined}}"

      # For cookie logs, extract domain
      - set:
          host.name: "{{parsed_cookie_domain.cookie_parts.domain}}"
        filter: "{{parsed_cookie_domain.cookie_parts.domain is defined}}"

      # Use pfhost if available
      - set:
          host.name: "{{kv_parsed.message.pfhost}}"
        filter: "{{kv_parsed.message.pfhost is defined}}"

  set_log_fields:
    actions:
      # Application log fields
      - set:
          log.level: "{{parsed_event.message.log_level}}"
        filter: "{{parsed_event.message.log_level is defined}}"

      - set:
          log.logger: "{{parsed_event.message.java_class}}"
        filter: "{{parsed_event.message.java_class is defined}}"

      - set:
          event.reason: "{{parsed_event.message.kv_pairs}}"
        filter: '{{parsed_event.message.kv_pairs is defined and not (parsed_event.message.kv_pairs | re_search(''event="AUTHN_''))}}'

  set_http_fields:
    actions:
      # HTTP access log fields
      - set:
          http.request.method: "{{parsed_event.message.http_request_method}}"
          http.version: "{{parsed_event.message.http_version}}"
          http.response.status_code: "{{parsed_event.message.http_response_status_code}}"
          http.response.body.bytes: "{{parsed_event.message.http_response_body_bytes}}"
          url.original: "{{parsed_event.message.url_original}}"
        filter: "{{parsed_event.message.http_request_method is defined}}"

      # Extract URL from application logs (GET: https://...)
      - set:
          url.original: "{{parsed_get_full_url.url_data.full_url}}"
        filter: "{{parsed_get_full_url.url_data.full_url is defined}}"

  set_source_fields:
    actions:
      - set:
          source.ip: "{{parsed_event.message.source_ip}}"
        filter: "{{parsed_event.message.source_ip is defined and parsed_event.message.source_ip | is_ipaddress}}"

      - set:
          source.domain: "{{parsed_event.message.source_ip}}"
        filter: "{{parsed_event.message.source_ip is defined and not (parsed_event.message.source_ip | is_ipaddress)}}"

      - set:
          user.name: "{{parsed_event.message.auth}}"
        filter: '{{parsed_event.message.auth is defined and parsed_event.message.auth != "-"}}'

      # Map subject from kv_pairs
      - set:
          user.name: "{{kv_parsed.message.subject}}"
        filter: '{{kv_parsed.message.subject is defined and kv_parsed.message.subject != ""}}'

      # Map ip from kv_pairs
      - set:
          source.ip: "{{kv_parsed.message.ip}}"
        filter: "{{kv_parsed.message.ip is defined and kv_parsed.message.ip | is_ipaddress}}"

  set_pingfederate_fields:
    actions:
      # Map all PingFederate-specific fields from both kv_parsed and kv_reason_parsed
      # Both parsers now use the same separator (item_sep: '\s'), so we can consolidate
      # by checking both sources. kv_reason_parsed takes precedence for quoted values.

      # ECS fields - mapped from both parsers
      - set:
          source.ip: "{{kv_reason_parsed.reason_data.ip or kv_parsed.message.ip}}"
        filter: "{{(kv_reason_parsed.reason_data.ip is defined and kv_reason_parsed.reason_data.ip | is_ipaddress) or (kv_parsed.message.ip is defined and kv_parsed.message.ip | is_ipaddress)}}"

      - set:
          user.name: "{{kv_reason_parsed.reason_data.subject or kv_parsed.message.subject}}"
        filter: '{{(kv_reason_parsed.reason_data.subject is defined and kv_reason_parsed.reason_data.subject != "") or (kv_parsed.message.subject is defined and kv_parsed.message.subject != "")}}'

      - set:
          host.name: "{{kv_reason_parsed.reason_data.pfhost or kv_parsed.message.pfhost}}"
        filter: "{{kv_reason_parsed.reason_data.pfhost is defined or kv_parsed.message.pfhost is defined}}"

      # URL mapping (connectionid contains URL)
      - set:
          url.original: "{{kv_reason_parsed.reason_data.connectionid or kv_parsed.message.connectionid}}"
        filter: "{{(kv_reason_parsed.reason_data.connectionid is defined and (kv_reason_parsed.reason_data.connectionid | re_search('^https?://'))) or (kv_parsed.message.connectionid is defined and (kv_parsed.message.connectionid | re_search('^https?://')))}}"

      # Event duration (responsetime in milliseconds) - convert to nanoseconds
      - set:
          event.duration: "{{(kv_reason_parsed.reason_data.responsetime or kv_parsed.message.responsetime) | int * 1000000}}"
        filter: "{{(kv_reason_parsed.reason_data.responsetime is defined and kv_reason_parsed.reason_data.responsetime | re_search('^[0-9]+$')) or (kv_parsed.message.responsetime is defined and kv_parsed.message.responsetime | re_search('^[0-9]+$'))}}"

      # Network protocol
      - set:
          network.protocol: "{{(kv_reason_parsed.reason_data.protocol or kv_parsed.message.protocol) | lower}}"
        filter: "{{kv_reason_parsed.reason_data.protocol is defined or kv_parsed.message.protocol is defined}}"

      # Destination domain from X-Forwarded-Host
      - set:
          destination.domain: "{{kv_reason_parsed.reason_data['X-Forwarded-Host'] or kv_parsed.message['X-Forwarded-Host']}}"
        filter: "{{kv_reason_parsed.reason_data['X-Forwarded-Host'] is defined or kv_parsed.message['X-Forwarded-Host'] is defined}}"

      # PingFederate custom fields - consolidated from both parsers
      # trackingid: extract from tid prefix first (will be overridden by KV pairs if present)
      - set:
          pingfederate.trackingid: "tid:{{parsed_event.message.tracking_id}}"
        filter: "{{parsed_event.message.tracking_id is defined and parsed_event.message.tracking_id != None and parsed_event.message.tracking_id != ''}}"

      - set:
          pingfederate.trackingid: "{{kv_reason_parsed.reason_data.trackingid or kv_parsed.message.trackingid}}"
        filter: "{{kv_reason_parsed.reason_data.trackingid is defined or kv_parsed.message.trackingid is defined}}"

      - set:
          pingfederate.transactionid: "{{kv_reason_parsed.reason_data.transactionid or kv_parsed.message.transactionid}}"
        filter: "{{kv_reason_parsed.reason_data.transactionid is defined or kv_parsed.message.transactionid is defined}}"

      - set:
          pingfederate.event: "{{kv_reason_parsed.reason_data.event or kv_parsed.message.event}}"
        filter: "{{kv_reason_parsed.reason_data.event is defined or kv_parsed.message.event is defined}}"

      - set:
          pingfederate.connectionid: "{{kv_reason_parsed.reason_data.connectionid or kv_parsed.message.connectionid}}"
        filter: "{{kv_reason_parsed.reason_data.connectionid is defined or kv_parsed.message.connectionid is defined}}"

      - set:
          pingfederate.protocol: "{{kv_reason_parsed.reason_data.protocol or kv_parsed.message.protocol}}"
        filter: "{{kv_reason_parsed.reason_data.protocol is defined or kv_parsed.message.protocol is defined}}"

      - set:
          pingfederate.role: "{{kv_reason_parsed.reason_data.role or kv_parsed.message.role}}"
        filter: "{{kv_reason_parsed.reason_data.role is defined or kv_parsed.message.role is defined}}"

      - set:
          pingfederate.status: "{{kv_reason_parsed.reason_data.status or kv_parsed.message.status}}"
        filter: "{{kv_reason_parsed.reason_data.status is defined or kv_parsed.message.status is defined}}"

      - set:
          pingfederate.responsetime: "{{kv_reason_parsed.reason_data.responsetime or kv_parsed.message.responsetime}}"
        filter: "{{kv_reason_parsed.reason_data.responsetime is defined or kv_parsed.message.responsetime is defined}}"

      - set:
          pingfederate.assertionid: "{{kv_reason_parsed.reason_data.assertionid or kv_parsed.message.assertionid}}"
        filter: "{{kv_reason_parsed.reason_data.assertionid is defined or kv_parsed.message.assertionid is defined}}"

      - set:
          pingfederate.attrackingid: "{{kv_reason_parsed.reason_data.attrackingid or kv_parsed.message.attrackingid}}"
        filter: "{{kv_reason_parsed.reason_data.attrackingid is defined or kv_parsed.message.attrackingid is defined}}"

      - set:
          pingfederate.attributes: "{{kv_reason_parsed.reason_data.attributes or kv_parsed.message.attributes}}"
        filter: "{{kv_reason_parsed.reason_data.attributes is defined or kv_parsed.message.attributes is defined}}"

      - set:
          pingfederate.authenticationsourceid: "{{kv_reason_parsed.reason_data.authenticationsourceid or kv_parsed.message.authenticationsourceid}}"
        filter: "{{kv_reason_parsed.reason_data.authenticationsourceid is defined or kv_parsed.message.authenticationsourceid is defined}}"

      - set:
          pingfederate.authnsessionexpiry: "{{kv_reason_parsed.reason_data.authnsessionexpiry or kv_parsed.message.authnsessionexpiry}}"
        filter: "{{kv_reason_parsed.reason_data.authnsessionexpiry is defined or kv_parsed.message.authnsessionexpiry is defined}}"

      - set:
          pingfederate.connectionname: "{{kv_reason_parsed.reason_data.connectionname or kv_parsed.message.connectionname}}"
        filter: "{{kv_reason_parsed.reason_data.connectionname is defined or kv_parsed.message.connectionname is defined}}"

      - set:
          pingfederate.granttype: "{{kv_reason_parsed.reason_data.granttype or kv_parsed.message.granttype}}"
        filter: "{{kv_reason_parsed.reason_data.granttype is defined or kv_parsed.message.granttype is defined}}"

      - set:
          pingfederate.x_forwarded_vip: "{{kv_reason_parsed.reason_data['X-Forwarded-Vip'] or kv_parsed.message['X-Forwarded-Vip']}}"
        filter: "{{kv_reason_parsed.reason_data['X-Forwarded-Vip'] is defined or kv_parsed.message['X-Forwarded-Vip'] is defined}}"

      - set:
          pingfederate.x_forwarded_host: "{{kv_reason_parsed.reason_data['X-Forwarded-Host'] or kv_parsed.message['X-Forwarded-Host']}}"
        filter: "{{kv_reason_parsed.reason_data['X-Forwarded-Host'] is defined or kv_parsed.message['X-Forwarded-Host'] is defined}}"

      - set:
          pingfederate.trusted_network: "{{kv_reason_parsed.reason_data.trustedNetwork or kv_parsed.message.trustedNetwork}}"
        filter: "{{kv_reason_parsed.reason_data.trustedNetwork is defined or kv_parsed.message.trustedNetwork is defined}}"

      - set:
          pingfederate.requestid: "{{kv_reason_parsed.reason_data.requestid or kv_parsed.message.requestid}}"
        filter: "{{kv_reason_parsed.reason_data.requestid is defined or kv_parsed.message.requestid is defined}}"

      - set:
          pingfederate.sri: "{{kv_reason_parsed.reason_data.sri or kv_parsed.message.sri}}"
        filter: "{{kv_reason_parsed.reason_data.sri is defined or kv_parsed.message.sri is defined}}"

      - set:
          pingfederate.virtualserverid: "{{kv_reason_parsed.reason_data.virtualserverid or kv_parsed.message.virtualserverid}}"
        filter: "{{kv_reason_parsed.reason_data.virtualserverid is defined or kv_parsed.message.virtualserverid is defined}}"

  set_ecs_categorization:
    actions:
      # Note: Authentication events regex consolidated for maintainability
      # AUTH_EVENTS_REGEX = event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"

      # Authentication attempt events - MUST BE FIRST to take precedence
      - set:
          event.category: [authentication]
          event.type: [start]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="AUTHN_ATTEMPT"''))}}'

      # Authentication request events
      - set:
          event.category: [authentication]
          event.type: [start]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="AUTHN_REQUEST"''))}}'

      # Authentication session created events
      - set:
          event.category: [authentication]
          event.type: [start]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="AUTHN_SESSION_CREATED"''))}}'

      # Authentication session used events
      - set:
          event.category: [authentication]
          event.type: [info]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="AUTHN_SESSION_USED"''))}}'

      # Authentication session deleted events
      - set:
          event.category: [authentication]
          event.type: [end]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="AUTHN_SESSIONS_DELETED"''))}}'

      # OAuth events
      - set:
          event.category: [authentication]
          event.type: [start]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="OAuth"''))}}'

      # SSO events
      - set:
          event.category: [authentication]
          event.type: [start]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="SSO"''))}}'

      # Single Logout events
      - set:
          event.category: [authentication]
          event.type: [end]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="SLO"''))}}'

      # Session revocation events
      - set:
          event.category: [authentication]
          event.type: [end]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="SRI_REVOKED"''))}}'

      # HTTP access logs (exclude all authentication events using consolidated regex)
      - set:
          event.category: [web]
          event.type: [access]
        filter: '{{parsed_event.message.http_request_method is defined and not (parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"'')))}}'

      # Heartbeat monitoring events (exclude authentication events using consolidated regex)
      - set:
          event.category: [web]
          event.type: [access]
        filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('heartbeat\\.ping')) and not (parsed_event.message.kv_pairs | re_search('event=\"(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)\"'))}}"

      # Cookie management events (exclude authentication events using consolidated regex)
      - set:
          event.category: [web]
          event.type: [info]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''cookie|Cookie'')) and not (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"''))}}'

      # Request tracking events (exclude authentication events - uses simpler event= check)
      - set:
          event.category: [web]
          event.type: [info]
        filter: "{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search('request ID|TrackingIdSupport')) and not (parsed_event.message.kv_pairs | re_search('event='))}}"

      # Locale/configuration events (exclude authentication events using consolidated regex)
      - set:
          event.category: [configuration]
          event.type: [info]
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''Locale|clientCert|X509ClientCertExtractor'')) and not (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"''))}}'

      # GET requests from application logs (exclude authentication events using consolidated regex)
      - set:
          event.category: [web]
          event.type: [access]
          http.request.method: "GET"
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''^GET:'')) and not (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"''))}}'

      # Authentication outcome: success (for all auth events using consolidated regex)
      - set:
          event.outcome: success
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"'')) and (parsed_event.message.kv_pairs | re_search(''status="success"''))}}'

      # Authentication outcome: failure (for all auth events using consolidated regex)
      - set:
          event.outcome: failure
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"'')) and (parsed_event.message.kv_pairs | re_search(''status="failure"''))}}'

      # Authentication outcome: in-progress (for all auth events using consolidated regex)
      - set:
          event.outcome: unknown
        filter: '{{parsed_event.message.kv_pairs is defined and (parsed_event.message.kv_pairs | re_search(''event="(AUTHN_ATTEMPT|AUTHN_REQUEST|AUTHN_SESSION_CREATED|AUTHN_SESSION_USED|AUTHN_SESSIONS_DELETED|OAuth|SSO|SLO|SRI_REVOKED)"'')) and (parsed_event.message.kv_pairs | re_search(''status="inprogress"''))}}'
